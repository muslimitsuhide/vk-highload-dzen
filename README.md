# Проектирование высоконагруженной контентной платформы
Курсовая работа в рамках 3-го семестра программы по Веб-разработке ***Образовательного центра VK x МГТУ им.Н.Э.Баумана*** (ex. "Технопарк") по дисциплине "Проектирование высоконагруженных систем"

***Автор:*** Мамадаев Муслим ([Telegram](https://t.me/muslimitsuhide), [VK](https://vk.com/muslimitsuhide))

---

#### Содержание:
1. [Тема, функционал и аудитория](#1)
2. [Расчёт нагрузки](#2)
3. [Список используемых источников](#3)
---

## Часть 1. Тема, функционал и аудитория<a name="1"></a>

### Тема курсовой работы: ***"Проектирование контентной платформы"***
В качестве примера выбран один из ведущих в России сервисов обмена и просмотра контента - [Дзен](https://dzen.ru/)

### Ключевой функционал сервиса:
- Регистрация и авторизация пользователей;
- Создание собственного канала;
- Создание контента (собственных публикаций);
    - Возможность написать статью/пост;
    - Возможность загрузить видео;
- Оценка публикаций;
    - Возможность поставить лайк/дизлайк на публикацию;
    - Возможность написать комментарий под публикацией;
- Редактирование ранее написанных статей/постов;
- Подписка на других пользователей;
- Поиск (по названию канала/видео/статьи или поста).

### Ключевые продуктовые решения:
- **Персонализированная лента и рекомендации** публикаций и каналов для пользователей. С помощью алгоритмов анализируются интересы и предпочтения, чтобы предложить максимально релевантный контент, который будет интересен пользователю;
- Дзен собирает данные о пользователе (лайки, история чтения статей/постов, взаимодейтвие с контентом и т.д.) и в дальнейшем эти данные с помощью алгоритмов анализируются и используются для подбора **релевантных рекламных предложений** для конкретного пользователя;
- **Монетизация для партнеров:** Партнеры Дзена могут зарабатывать на своем контенте через размещение рекламы. Они получают долю от выручки, которую генерирует их контент благодаря показам и взаимодействию с рекламой. Она также подбирается на основе интересов и предпочтений пользователя и отображается в ленте.

### Целевая аудитория:
По данным ***Mediascope[^1]***, аудитория Дзена в России составляет **81 млн человек** в месяц. Дзен охватывает 67.5% населения России. 26.4% россиян используют Дзен каждый день. Это примерно 32 млн пользователей. 

- MAU: 81М
- DAU: 32М

![Аудитория Дзена](img/stat.png)

По данным ***Similarweb[^2]***, 90.98% мирового трафика Дзена приходится на Россию. Второе место занимает Беларусь с 1.95%, третье — Казахстан с 1.23%.

![Трафик Дзена](img/top.png)

## Часть 2. Расчёт нагрузки<a name="2"></a>

### Продуктовые метрики:

#### MAU - 81 млн пользователей [^1]
#### DAU - 32 млн пользователей [^1]

### Средний размер харанилища пользователя по типам:

#### Основная информация: 
- Название канала может содержать максимум ***140 символов***, а описание максимум ***300 символов***. Каждый символ занимает 1 байт, тогда на хранение этих данных необходимо `440 байт`. 
- Аватарка должна быть весом не более `10МБ`. 


#### Дополнительная информация: 
Также имеется дополнительная информация, как ссылка на сайт или блог (*1 ссылка*), телефон (*максимум 3 номера*), почта (*максимум 3 адреса*) и соцсети (*максимум 5 ссылок*). 
- Для хранения URL в среднем понадобится `100 байт`, так как храниться их может максимум 6, то понадобится `600 байт` памяти. 
- **Самый длинный номер телефона[^3]** содержит 15 символов, поэтому для хранения 3 номеров нам необходимо максимум `45 байт`. 
- **Под адрес электронной почты выделим[^4]** `320 байт`, а так как их может быть 3, то понадобится `960 байт` памяти. Под дополнительную информацию необходимо 

#### Публикации
- **Посты** подразумевают собой только текстовый формат, длина которого от 3 до 6 тысяч символов, получается нужно около `6КБ` для хранения одного поста.
- **Статьи** подразумевают собой как и тексовый формат, так и фотографии, максимальный размер фотографии - `30МБ` и добавить максимально можно 10 фотографий, получается `300МБ`. Объем текста в статьях ограничен 200 символами, поэтому получаем `200 байт`. Итого максимальный вес статьи составляет около `300МБ`. В среднем в статье на Дзене встречается около 5-6 изображений, поэтому предположим, что средний вес статьи ~ `150МБ`
- **Видео**. Максимальный размер - `10.000МБ`. Средняя продолжительность видео на Дзене - 15 минут, предположим, что оно загружено в качестве 1080p, поэтому его вес будет равен примерно ~ `300МБ`.

Так как никакой сводки по среднему количеству публикаций у пользователя в Дзене нет, то предположим, что в среднем у пользователя Дзена раземещено 2 поста, 2 статьи и 2 видео. Итого под публикации пользователя нужно в среднем ~`900МБ`.

| Хранимые данные   | Оценочный размер на пользователя         |
|:-------------------------:|:--------------------------------:|
| Аватар                    | `Max 10 МБ`                      |
| Основная информация       | `440 байт`                       |
| Дополнительная информация | `1605 байт`                      |
| Публикации                | `900 МБ`                         |

**Итого оценочно:** ~ `910 МБ` на пользователя при полном заполнении информации о канале и публикации 2 статей, 2 постов и 2 видео. 

### Среднее количество действий пользователя по типам в день:

![Количество публикаций](img/how_many.png)

- Создание контента: `5.8 публикаций/нед / 7 суток/нед ~ 0.82 публикаций/сутки`[^5]

- Оценка публикаций: `500 оценок/месяц / 30 суток/месяц ~ 16.6 оценок/сутки`

- Подписка на других пользователей: `20 подписок/месяц / 30 суток/месяц ~ 0.66 подписок/сутки`

- Использование поиска: `~ 1 поиск/сутки`

### Технические метрики

### Размер хранения в разбивке по типам данных:

| Тип данных | Оценочный размер на 1 пользователя | Суммарный прирост |
|:----------:|:----------------------------------:|:---------------------------:|
| Данные пользователей      | `910 МБ`            | `110ПБ/месяц` |
| История поиска            | `1 КБ`          | `11.5ГБ/месяц` |

Расчёты хранилища:
- Данные пользователей: `910МБ * 81млн MAU * 0.15 (коэфициент прироста пользователей) = 110ПБ/месяц`
- История поиска: `1КБ * 81млн MAU * 0.15 (коэфициент прироста пользователей) = 11.5ГБ/месяц`

### RPS по типам запросов:

| Тип запроса   | Средний оценочный RPS          |
|:-------------------------------:|:------------:|
| Авторизация                     | `7.4`        |
| Регистрация                     | `0.47`       |
| Создание контента               | `303`         |
| Оценка публикаций               | `6148`         |
| Подписка на других пользователей| `244`         |
| Поиск                           | `370`         |
| Просмотр каналов                | `3700`         |

- Авторизация: `0.02 * 32млн DAU / (24 * 3600) с/сут ~ 7.4 RPS` - каждая 50-ая сессия в сервисе просит авторизации.
- Регистрация: `0.15 годовой коэф. прироста пользователей * 100млн / (365 * 24 * 3600) с/сут ~ 0.47 RPS`
- Создание контента: `0.82 публикаций/сутки/пользователь * 32млн DAU / (24 * 3600) с/сут ~ 303 RPS`
- Оценка публикаций: `16.6 оценок/сутки/пользователель * 32млн DAU / (24 * 3600) с/сут ~ 6148 RPS`
- Подписка на других пользователей: `0.66 подписок/сутки/пользователь * 32млн DAU / (24 * 3600) с/сут ~ 244 RPS`
- Поиск: `1 поиск/сутки/пользователь * 32млн DAU / (24 * 3600) с/сут ~ 370 RPS`
- Просмотр канала: `32млн DAU / (24 * 3600) с/сут ~ 3700 RPS` при условии, что пользователь просматривает 10 каналов 1 раз в день

Суммарный RPS по основным запросам: = `10773`

### Сетевой трафик

**Пиковое потребление в течение суток (Гбит/с) по типам трафика:**
| Тип трафика        | Пиковое потребление, Гбит/с       | Суммарный суточный трафик, Гбит/сутки  |
|--------------------|-----------------------------------|----------------------------------------|
| Cтатические файлы  | `86.7`                            | `2496960`                                |
| API                | `0.36`                            | `1036800`                                |

Расчёты трафика:

**Средний:**
  - API: `10773 RPS * 1.5 КБ средний размер запроса / (1024 * 1024 / 8) КБ/Гбит = 0.12 Гбит/с`
  - Статика: `3700 RPS * 1 МБ средний размер запроса / (1024 / 8) МБ/Гбит = 28.9 Гбит/с`

**Пиковый:**

  Пиковый коэф трафика от среднего с запасом = 3, т.к. недельный пиковый коэф = 2.07
   - API: `3 пиковый коэф * 0.12 Гбит/с средний трафик = 0.36 Гбит/с`
   - Статика: `3 пиковый коэф * 28.9 Гбит/с средний трафик = 86.7 Гбит/с`

**Суммарный суточный:**
  - API: `0.12 Гбит/с средний трафик * (24 * 3600) с/сут = 1036800 Гбит/сут`
  - Статика: `28.9 Гбит/с средний трафик * (24 * 3600) с/сут = 2496960 Гбит/сут`

### Список используемых источников <a name="3"></a>:
[^1]: [Аналитика Дзена с Mediascope](https://mediascope.net/data/)

[^2]: [Аналитика Дзена с Similarweb](https://pro.similarweb.com/#/digitalsuite/websiteanalysis/overview/website-performance/*/999/3m?webSource=Total&key=dzen.ru)

[^3]: [Самый длинный номер телефона в мире](https://fsnslnr.su/faq/kakoi-samyi-dlinnyi-nomer-telefona-v-mire)

[^4]: [Длина почтового адреса](https://habr.com/ru/articles/274985/comments/#comment_8737021)

[^5]: [Опрос о количестве публикаций](https://dzen.ru/a/YbIJWOoUI0j-rITN)